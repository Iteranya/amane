<!DOCTYPE html>
<html lang="en" class="bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kokoro Audiobook Creator</title>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome via CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Custom styles for active tab and loader */
        .tab-active {
            background-color: #1d4ed8; /* bg-blue-700 */
            color: white;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide sections by default */
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }
    </style>
</head>
<body class="font-sans text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Kokoro Audiobook Creator</h1>
            <p class="text-lg text-gray-600 mt-2">Convert your PDFs to audiobooks and manage your files.</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b border-gray-300 mb-8">
            <button id="nav-converter" class="py-2 px-6 font-semibold text-gray-600 hover:bg-blue-100 rounded-t-lg transition-colors duration-300 tab-active">
                <i class="fas fa-book-open mr-2"></i>Converter
            </button>
            <button id="nav-manager" class="py-2 px-6 font-semibold text-gray-600 hover:bg-blue-100 rounded-t-lg transition-colors duration-300">
                <i class="fas fa-folder-open mr-2"></i>File Manager
            </button>
        </nav>

        <main>
            <!-- Converter Page -->
            <section id="converter-page" class="page-section active">
                <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 text-center">Convert PDF to Audiobook</h2>
                    <form id="conversion-form">
                        <div class="mb-4">
                            <label for="pdf-select" class="block text-gray-700 text-sm font-bold mb-2">1. Select a PDF:</label>
                            <select id="pdf-select" name="pdf_filename" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                <option value="" disabled selected>Loading PDFs...</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="audio-filename" class="block text-gray-700 text-sm font-bold mb-2">2. Output Audio Filename:</label>
                            <input type="text" id="audio-filename" name="audio_filename" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., my-audiobook.mp3" required>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label for="character-select" class="block text-gray-700 text-sm font-bold mb-2">3. Select a Voice:</label>
                                <select id="character-select" name="character" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="af_bella" selected>Bella (Default)</option>
                                    <option value="en_david">David</option>
                                    <option value="es_sofia">Sofia</option>
                                    <option value="jp_kokoro">Kokoro</option>
                                </select>
                            </div>
                             <div>
                                <label for="language-select" class="block text-gray-700 text-sm font-bold mb-2">4. Select a Language:</label>
                                <select id="language-select" name="language" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="a" selected>Auto-Detect (Default)</option>
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="jp">Japanese</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex items-center justify-center">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-300">
                                <i class="fas fa-magic-wand-sparkles mr-2"></i>Create Audiobook
                            </button>
                        </div>
                    </form>
                    <div id="conversion-status" class="mt-6 text-center"></div>
                </div>
            </section>

            <!-- File Manager Page -->
            <section id="manager-page" class="page-section">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                    <!-- PDF Files Column -->
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">
                            <i class="fas fa-file-pdf text-red-600 mr-2"></i>PDF Files
                        </h2>
                        <form id="pdf-upload-form" class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="pdf-file-input">
                                Upload New PDF
                            </label>
                            <div class="flex">
                                <input id="pdf-file-input" type="file" name="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept=".pdf" required>
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg ml-2 transition-colors duration-300">
                                    <i class="fas fa-upload"></i>
                                </button>
                            </div>
                        </form>
                        <ul id="pdf-list" class="space-y-2">
                            <!-- PDF files will be listed here -->
                        </ul>
                    </div>

                    <!-- Audio Files Column -->
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">
                            <i class="fas fa-file-audio text-blue-600 mr-2"></i>Audio Files
                        </h2>
                        <ul id="audio-list" class="space-y-3">
                            <!-- Audio files will be listed here -->
                        </ul>
                    </div>

                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Element References ---
    const navConverter = document.getElementById('nav-converter');
    const navManager = document.getElementById('nav-manager');
    const converterPage = document.getElementById('converter-page');
    const managerPage = document.getElementById('manager-page');

    const conversionForm = document.getElementById('conversion-form');
    const pdfSelect = document.getElementById('pdf-select');
    const audioFilenameInput = document.getElementById('audio-filename');
    const conversionStatus = document.getElementById('conversion-status');

    const pdfUploadForm = document.getElementById('pdf-upload-form');
    const pdfFileInput = document.getElementById('pdf-file-input');
    const pdfList = document.getElementById('pdf-list');
    const audioList = document.getElementById('audio-list');

    const API_BASE_URL = window.location.origin; // Assumes API is on the same host

    // --- Navigation Logic ---
    function showPage(pageId) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');

        document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
        if (pageId === 'converter-page') {
            navConverter.classList.add('tab-active');
        } else {
            navManager.classList.add('tab-active');
        }
    }

    navConverter.addEventListener('click', () => showPage('converter-page'));
    navManager.addEventListener('click', () => showPage('manager-page'));

    // --- API Helper Functions ---
    async function apiFetch(url, options = {}) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
            }
            // Handle responses that might not have a JSON body (like delete)
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return await response.json();
            }
            return { ok: true };
        } catch (error) {
            console.error('API Fetch Error:', error);
            throw error;
        }
    }

    // --- Data Fetching and Rendering ---
    async function fetchAndRenderFiles() {
        try {
            const [pdfFiles, audioFiles] = await Promise.all([
                apiFetch(`${API_BASE_URL}/files`),
                apiFetch(`${API_BASE_URL}/audio`)
            ]);

            renderFileList(pdfList, pdfFiles, 'files');
            renderFileList(audioList, audioFiles, 'audio');
            populatePdfDropdown(pdfFiles);
        } catch (error) {
            pdfList.innerHTML = `<li class="text-red-500">Error loading PDF files: ${error.message}</li>`;
            audioList.innerHTML = `<li class="text-red-500">Error loading audio files: ${error.message}</li>`;
            pdfSelect.innerHTML = `<option value="" disabled selected>Could not load PDFs</option>`;
        }
    }

    function renderFileList(listElement, files, type) {
        listElement.innerHTML = '';
        if (files.length === 0) {
            listElement.innerHTML = `<li class="text-gray-500 italic">No files found.</li>`;
            return;
        }

        files.forEach(filename => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-2 border-b last:border-b-0 hover:bg-gray-50';

            let fileInfoHtml = `<span class="truncate mr-4">${filename}</span>`;

            // Add audio player for audio files
            if (type === 'audio') {
                fileInfoHtml = `
                    <div class="flex-grow">
                        <span class="block truncate">${filename}</span>
                        <audio controls class="w-full mt-1 h-8" preload="metadata">
                            <source src="${API_BASE_URL}/audio/${filename}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                `;
            }

            li.innerHTML = `
                ${fileInfoHtml}
                <div class="flex-shrink-0">
                    <a href="${API_BASE_URL}/${type}/${filename}" download class="text-blue-500 hover:text-blue-700 p-2" title="Download">
                        <i class="fas fa-download"></i>
                    </a>
                    <button data-filename="${filename}" data-type="${type}" class="delete-btn text-red-500 hover:text-red-700 p-2" title="Delete">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            listElement.appendChild(li);
        });
    }

    function populatePdfDropdown(pdfFiles) {
        pdfSelect.innerHTML = '';
        if (pdfFiles.length === 0) {
            pdfSelect.innerHTML = `<option value="" disabled selected>No PDFs available to convert</option>`;
            return;
        }

        pdfFiles.forEach(filename => {
            const option = document.createElement('option');
            option.value = filename;
            option.textContent = filename;
            pdfSelect.appendChild(option);
        });

        // Auto-fill audio filename based on first PDF
        if (pdfFiles.length > 0) {
            updateAudioFilename(pdfFiles[0]);
        }
    }

    function updateAudioFilename(pdfFilename) {
        const nameWithoutExt = pdfFilename.substring(0, pdfFilename.lastIndexOf('.')) || pdfFilename;
        audioFilenameInput.value = `${nameWithoutExt}.mp3`;
    }

    // --- Event Handlers ---
    pdfSelect.addEventListener('change', (e) => updateAudioFilename(e.target.value));

    pdfUploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('file', pdfFileInput.files[0]);

        try {
            await apiFetch(`${API_BASE_URL}/files`, {
                method: 'POST',
                body: formData,
            });
            pdfUploadForm.reset();
            await fetchAndRenderFiles(); // Refresh all lists
        } catch (error) {
            alert(`Upload failed: ${error.message}`);
        }
    });

    conversionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(conversionForm);

        conversionStatus.innerHTML = `
            <div class="flex flex-col items-center">
                <div class="loader"></div>
                <p class="mt-2 text-blue-600 font-semibold">Converting... This may take a moment.</p>
            </div>
        `;

        try {
            const result = await apiFetch(`${API_BASE_URL}/audiobooks/from-pdf`, {
                method: 'POST',
                body: formData,
            });
            conversionStatus.innerHTML = `
                <p class="text-green-600 font-bold p-3 bg-green-100 rounded-lg">
                    <i class="fas fa-check-circle mr-2"></i>Success! Audio file "${result.audio_file}" created.
                </p>`;
            await fetchAndRenderFiles(); // Refresh lists to show new audio file
        } catch (error) {
            conversionStatus.innerHTML = `
                <p class="text-red-600 font-bold p-3 bg-red-100 rounded-lg">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Error: ${error.message}
                </p>`;
        }
    });

    document.body.addEventListener('click', async (e) => {
        const deleteButton = e.target.closest('.delete-btn');
        if (deleteButton) {
            const filename = deleteButton.dataset.filename;
            const type = deleteButton.dataset.type;

            if (confirm(`Are you sure you want to delete "${filename}"?`)) {
                try {
                    await apiFetch(`${API_BASE_URL}/${type}/${filename}`, {
                        method: 'DELETE',
                    });
                    await fetchAndRenderFiles(); // Refresh lists
                } catch (error) {
                    alert(`Failed to delete file: ${error.message}`);
                }
            }
        }
    });

    // --- Initial Load ---
    fetchAndRenderFiles();
});
</script>

</body>
</html>
